#!/bin/bash

# --- 1. CONFIG & GLOBALS ---
ORIGINAL_RESOLV="/etc/resolv.conf.bak"
STAGES_COMPLETED=()
REQUIRED_DISK_GB=5

# --- 2. THE NUCLEAR ROLLBACK (The "Undo Everything" Engine) ---
cleanup_on_failure() {
    local exit_code=$?
    if [ $exit_code -ne 0 ]; then
        echo -e "\n\e[31m[!] CRITICAL FAILURE. Initiating Full Rollback...\e[0m"
        
        # 1. Uninstall K3s
        if [[ " ${STAGES_COMPLETED[*]} " =~ " k3s_install " ]]; then
            [ -f /usr/local/bin/k3s-uninstall.sh ] && /usr/local/bin/k3s-uninstall.sh
            [ -f /usr/local/bin/k3s-agent-uninstall.sh ] && /usr/local/bin/k3s-agent-uninstall.sh
        fi

        # 2. Restore DNS & systemd-resolved
        if [[ " ${STAGES_COMPLETED[*]} " =~ " dns_config " ]]; then
            mv "$ORIGINAL_RESOLV" /etc/resolv.conf 2>/dev/null
            systemctl enable --now systemd-resolved 2>/dev/null
        fi

        # 3. Re-enable Swap (if we disabled it)
        if [[ " ${STAGES_COMPLETED[*]} " =~ " swap_off " ]]; then
            swapon -a
        fi

        # 4. Remove custom tools
        rm -f /usr/local/bin/netctl
        
        echo -e "\e[32m[+] System restored to pre-install state.\e[0m"
    fi
    exit $exit_code
}

trap cleanup_on_failure ERR SIGINT SIGTERM

# --- 3. HARDWARE & OS VALIDATION ---
validate_system() {
    echo "ðŸ›¡ï¸ Validating System Requirements..."
    
    # Check Disk Space
    AVAILABLE_DISK=$(df / --output=avail -G | tail -n1)
    if [ "$AVAILABLE_DISK" -lt "$REQUIRED_DISK_GB" ]; then
        echo "Error: Need at least ${REQUIRED_DISK_GB}GB free space." && exit 1
    fi

    # Disable Swap (K8s Requirement)
    echo "ðŸš« Disabling Swap..."
    sed -i '/swap/d' /etc/fstab
    swapoff -a
    STAGES_COMPLETED+=("swap_off")

    # Detect OS
    [ -f /etc/os-release ] && . /etc/os-release || exit 1
    echo "Detected: $PRETTY_NAME"
}

# --- 4. ENVIRONMENT PREP ---
setup_env() {
    echo "ðŸ“¦ Installing Project Essentials..."
    case "$ID" in
        ubuntu|debian)
            apt-get update && apt-get install -y curl wget git net-tools open-iscsi nfs-common dialog
            ufw disable 2>/dev/null # K3s manages its own networking
            ;;
        fedora|rhel)
            dnf install -y curl wget git net-tools iscsi-initiator-utils nfs-utils dialog
            systemctl stop firewalld && systemctl disable firewalld
            ;;
    esac

    # DNS Lock
    cp /etc/resolv.conf "$ORIGINAL_RESOLV"
    systemctl disable --now systemd-resolved 2>/dev/null
    rm -f /etc/resolv.conf
    echo -e "nameserver 8.8.8.8\nnameserver 1.1.1.1" > /etc/resolv.conf
    STAGES_COMPLETED+=("dns_config")
}

# --- 5. THE NETCTL TOOL CREATION ---
create_netctl() {
    cat << 'EOF' > /usr/local/bin/netctl
#!/bin/bash
if [ -z "$1" ] || [ -z "$2" ]; then
    echo "Usage: sudo netctl <IP> <GATEWAY>"
    exit 1
fi
cat << EOM > /etc/netplan/01-netcfg.yaml
network:
  version: 2
  renderer: networkd
  ethernets:
    $(ip -o link show | awk -F': ' '{print $2}' | grep -v lo | head -n1):
      dhcp4: no
      addresses: [$1/24]
      gateway4: $2
      nameservers:
        addresses: [8.8.8.8, 1.1.1.1]
EOM
netplan apply && echo "Network set to $1"
EOF
    chmod +x /usr/local/bin/netctl
}

# --- 6. K3S INSTALLATION WIZARD ---
install_k3s() {
    ROLE=$(dialog --clear --title "K3s Deployer" --menu "Role:" 12 35 2 \
          "Master" "Control Plane" "Worker" "Agent" 3>&1 1>&2 2>&3)

    if [ "$ROLE" == "Master" ]; then
        curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="--disable traefik" K3S_KUBECONFIG_MODE="644" sh -s -
        STAGES_COMPLETED+=("k3s_install")
        
        # Install Ingress-Nginx
        echo "ðŸŒ Deploying Nginx Ingress Controller..."
        kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/cloud/deploy.yaml
        
    else
        M_IP=$(dialog --inputbox "Master IP:" 8 40 3>&1 1>&2 2>&3)
        M_TOKEN=$(dialog --inputbox "Master Token:" 8 40 3>&1 1>&2 2>&3)
        curl -sfL https://get.k3s.io | K3S_TOKEN="$M_TOKEN" K3S_URL="https://${M_IP}:6443" K3S_NODE_NAME="$(hostname)" sh -
        STAGES_COMPLETED+=("k3s_install")
    fi
}

# --- EXECUTION ---
[[ $EUID -ne 0 ]] && echo "Must run as root" && exit 1

validate_system
setup_env
create_netctl
install_k3s

echo -e "\n\e[32mðŸŒŸ SUCCESS: Node is ready. Use 'netctl' for future IP changes.\e[0m"
